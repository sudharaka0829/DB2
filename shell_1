#!/bin/sh

# Switch to the db2inst1 user and define functions
su - db2inst1 << 'EOF'  | grep -v 'Last'
# DB2 connection details
DB_USER="your_db_username"
DB_PASS="your_db_password"
DB_NAME="pegadb"

# Function to execute DB2 queries
execute_db2_query() {
    db2 connect to $DB_NAME > /dev/null 2>&1
    db2 -x "$1"
}

# Function to get Bufferpools data
get_bufferpools_data() {
    execute_db2_query "SELECT BP_NAME, TOTAL_HIT_RATIO, INDEX_HIT_RATIO FROM SYSIBMADM.BP_HITRATIO WHERE bp_name NOT LIKE 'IBMSYSTEM%'"
}

# Call function to collect buffer pools data
bufferpools_data=$(get_bufferpools_data)

# Output data in JSON format
echo '{"bufferpools":['
first=true
while read -r bufferpool totalhit idxhit; do
    if [ "$first" = true ]; then
        first=false
    else
        echo ","
    fi
    # Check if totalhit and idxhit are valid numbers or not
    if [[ "$totalhit" =~ ^[0-9.]+$ ]] && [[ "$idxhit" =~ ^[0-9.]+$ ]]; then
        echo -n '{"name":"' "$bufferpool" '", "total_hits":' "$totalhit" ', "index_hits":' "$idxhit" '}'
    else
        echo -n '{"name":"' "$bufferpool" '", "total_hits":null, "index_hits":null}'
    fi
done <<< "$bufferpools_data"
echo ']}'
EOF
