#!/bin/bash

# DB2 connection details
DB_USER="db2inst1"
DB_PASS="db2inst1"
DB_NAME="BOOK"

# Zabbix server details
ZABBIX_SERVER="<Zabbix server address>"
ZABBIX_HOST="<Host name>"

# Function to execute DB2 queries
execute_db2_query() {
  echo "$DB_PASS" | su - $DB_USER -c "db2 connect to $DB_NAME > /dev/null 2>&1 && db2 -x \"$1\""
}

# Function to send data to Zabbix
send_to_zabbix() {
  zabbix_sender -z $ZABBIX_SERVER -s $ZABBIX_HOST -k $1 -o $2
}

# SQL Query
QUERY="SELECT BP_NAME as bufferpool, TOTAL_HIT_RATIO_PERCENT AS totalhit, INDEX_HIT_RATIO_PERCENT AS idxhit FROM SYSIBMADM.BP_HITRATIO WHERE BP_NAME NOT LIKE 'IBMSYSTEM%'"

# Execute the query and fetch the data
result=$(execute_db2_query "$QUERY")

# Process the result
IFS=$'\n'
for line in $result; do
  bufferpool=$(echo $line | awk '{print $1}')
  totalhit=$(echo $line | awk '{print $2}')
  idxhit=$(echo $line | awk '{print $3}')
  
  # Print the data before sending to Zabbix
  echo "Bufferpool: $bufferpool, Total Hit Ratio: $totalhit, Index Hit Ratio: $idxhit"
  
  # Send the data to Zabbix
  send_to_zabbix "bufferpool.totalhit[$bufferpool]" "$totalhit"
  send_to_zabbix "bufferpool.idxhit[$bufferpool]" "$idxhit"
done
